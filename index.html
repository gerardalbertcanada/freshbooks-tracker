<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Hours Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #79b8ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --freshbooks-green: #0b7a3e;
            --freshbooks-green-hover: #0d9148;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo { display: flex; align-items: center; gap: 0.75rem; }

        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--accent), #a371f7);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.25rem;
        }

        h1 { font-size: 1.5rem; font-weight: 600; }

        .header-actions { display: flex; gap: 0.75rem; align-items: center; }

        .user-info {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px; font-size: 0.875rem;
        }

        .user-info .avatar {
            width: 28px; height: 28px;
            background: var(--accent);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.75rem;
        }

        .settings-btn, .logout-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 0.5rem;
        }

        .settings-btn:hover, .logout-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex; gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: transparent; border: none;
            color: var(--text-secondary);
            font-family: inherit; font-size: 0.95rem; font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
        }

        .nav-tab:hover { color: var(--text-primary); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Login Screen */
        .login-screen {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 60vh; text-align: center;
        }

        .login-screen .logo-large {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, var(--accent), #a371f7);
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 2.5rem;
            margin-bottom: 1.5rem;
        }

        .login-screen h2 { font-size: 1.75rem; margin-bottom: 0.5rem; }
        .login-screen p { color: var(--text-secondary); margin-bottom: 2rem; max-width: 400px; }

        .login-btn {
            display: inline-flex; align-items: center; gap: 0.75rem;
            background: var(--freshbooks-green); color: white; border: none;
            padding: 1rem 2rem; border-radius: 10px;
            font-family: inherit; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }

        .login-btn:hover {
            background: var(--freshbooks-green-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(11, 122, 62, 0.3);
        }

        .login-btn svg { width: 24px; height: 24px; }
        .login-note { margin-top: 1.5rem; font-size: 0.875rem; color: var(--text-secondary); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px; padding: 2rem;
            width: 90%; max-width: 500px;
            transform: translateY(20px); transition: transform 0.3s;
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal h2 {
            font-size: 1.25rem; margin-bottom: 1.5rem;
            display: flex; align-items: center; gap: 0.5rem;
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label {
            display: block; font-size: 0.875rem;
            color: var(--text-secondary); margin-bottom: 0.5rem;
        }

        .form-group input, .form-group select {
            width: 100%; padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary);
            font-family: inherit; font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--accent);
        }

        .form-group small {
            display: block; margin-top: 0.5rem;
            color: var(--text-secondary); font-size: 0.75rem;
        }

        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }

        .btn {
            flex: 1; padding: 0.75rem 1.5rem;
            border-radius: 8px; font-family: inherit;
            font-size: 0.875rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }

        .btn-primary { background: var(--accent); border: none; color: var(--bg-primary); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-secondary:hover { border-color: var(--text-secondary); color: var(--text-primary); }

        /* Dashboard */
        .dashboard { display: grid; gap: 1.5rem; }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px; padding: 1.5rem;
        }

        .card-header {
            display: flex; align-items: center;
            justify-content: space-between; margin-bottom: 1.5rem;
        }

        .card-title { font-size: 1rem; font-weight: 600; color: var(--text-secondary); }

        .filter-row {
            display: flex; gap: 1rem;
            align-items: flex-end; flex-wrap: wrap;
        }

        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }

        .filter-group label {
            font-size: 0.75rem; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.05em;
        }

        .filter-group select, .filter-group input {
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary);
            font-family: inherit; font-size: 0.9rem;
            cursor: pointer; min-width: 180px;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none; border-color: var(--accent);
        }

        .project-selector { display: flex; gap: 1rem; align-items: center; }

        .project-selector select {
            flex: 1; padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary);
            font-family: inherit; font-size: 1rem;
            cursor: pointer; min-width: 300px;
        }

        .project-selector select:focus { outline: none; border-color: var(--accent); }

        .refresh-btn, .load-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            height: 44px; padding: 0 1rem;
            border-radius: 8px; cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            gap: 0.5rem; font-family: inherit; font-size: 0.875rem;
        }

        .refresh-btn { width: 44px; padding: 0; }

        .refresh-btn:hover, .load-btn:hover {
            background: var(--accent); color: var(--bg-primary); border-color: var(--accent);
        }

        .refresh-btn.loading svg, .load-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .chart-container { position: relative; height: 500px; margin-top: 1rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }

        .stat-card { background: var(--bg-tertiary); border-radius: 12px; padding: 1.25rem; }

        .stat-label {
            font-size: 0.75rem; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value { font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: 700; }
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.danger { color: var(--danger); }

        .service-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }

        .service-table th, .service-table td {
            padding: 0.75rem 1rem; text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .service-table th {
            font-size: 0.75rem; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;
        }

        .service-table td { font-family: 'Space Mono', monospace; font-size: 0.875rem; }
        .service-table tr:last-child td { border-bottom: none; }
        .service-table .service-name { font-family: 'DM Sans', sans-serif; }
        .service-table .over-budget { color: var(--danger); }
        .service-table .on-track { color: var(--success); }
        .service-table .warning { color: var(--warning); }

        .empty-state {
            text-align: center; padding: 4rem 2rem; color: var(--text-secondary);
        }

        .empty-state svg { width: 64px; height: 64px; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--text-primary); }

        footer {
            margin-top: 2rem; padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            text-align: center; color: var(--text-secondary); font-size: 0.875rem;
        }

        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 48px; height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-overlay p { margin-top: 1rem; color: var(--text-secondary); }

        .toast {
            position: fixed; bottom: 2rem; right: 2rem;
            padding: 1rem 1.5rem; border-radius: 10px; font-size: 0.875rem;
            display: flex; align-items: center; gap: 0.75rem;
            transform: translateY(100px); opacity: 0;
            transition: all 0.3s; z-index: 3000;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); color: white; }
        .toast.success { background: var(--success); color: white; }

        .inline-loading {
            display: none; align-items: center; gap: 0.5rem;
            color: var(--text-secondary); font-size: 0.875rem; padding: 1rem;
        }

        .inline-loading.show { display: flex; }

        .inline-loading .spinner-small {
            width: 20px; height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block; padding: 0.25rem 0.75rem;
            border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.on-track { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .status-badge.warning { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .status-badge.over { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Connecting to FreshBooks...</p>
    </div>

    <div id="toast" class="toast"></div>

    <div class="container">
        <div id="loginScreen" class="login-screen" style="display: none;">
            <div class="logo-large">⏱</div>
            <h2>Project Hours Tracker</h2>
            <p>Connect your FreshBooks account to compare estimated vs actual project hours.</p>
            <button class="login-btn" onclick="loginWithFreshBooks()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                    <polyline points="10 17 15 12 10 7"></polyline>
                    <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
                Login with FreshBooks
            </button>
            <p class="login-note">You'll be redirected to FreshBooks to authorize access.</p>
        </div>

        <div id="dashboard" style="display: none;">
            <header>
                <div class="logo">
                    <div class="logo-icon">⏱</div>
                    <h1>Project Hours Tracker</h1>
                </div>
                <div class="header-actions">
                    <div id="userInfo" class="user-info" style="display: none;">
                        <div class="avatar" id="userAvatar">?</div>
                        <span id="userName">User</span>
                    </div>
                    <button class="settings-btn" onclick="openSettings()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"></path>
                        </svg>
                        Settings
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Logout
                    </button>
                </div>
            </header>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('projects')">Project Hours</button>
                <button class="nav-tab" onclick="switchTab('staff')">Staff Hours</button>
                <button class="nav-tab" onclick="switchTab('clients')">Client Hours</button>
            </div>

            <!-- Project Hours Tab -->
            <div id="projectsTab" class="tab-content active">
                <div class="dashboard">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Select Project</span>
                        </div>
                        <div class="project-selector">
                            <select id="projectSelect" onchange="onProjectChange()">
                                <option value="">-- Select a project --</option>
                            </select>
                            <button class="refresh-btn" onclick="refreshData()" title="Refresh data">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 4v6h-6M1 20v-6h6"></path>
                                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="statsContainer" class="stats-grid" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-label">Total Estimated</div>
                            <div id="estimatedHours" class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Actual</div>
                            <div id="actualHours" class="stat-value">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Hours by Service</span>
                        </div>
                        <div id="chartMessage" class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M3 3v18h18"></path>
                                <path d="M18 17V9M13 17V5M8 17v-3"></path>
                            </svg>
                            <h3>No Project Selected</h3>
                            <p>Select a project from the dropdown to view hours comparison</p>
                        </div>
                        <div class="chart-container" style="display: none;">
                            <canvas id="hoursChart"></canvas>
                        </div>
                    </div>

                    <div class="card" id="tableCard" style="display: none;">
                        <div class="card-header">
                            <span class="card-title">Service Breakdown</span>
                        </div>
                        <table class="service-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Estimated</th>
                                    <th>Actual</th>
                                    <th>Difference</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="serviceTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Staff Hours Tab -->
            <div id="staffTab" class="tab-content">
                <div class="dashboard">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Filter Staff Hours</span>
                        </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Staff Member</label>
                                <select id="staffSelect">
                                    <option value="">-- Select staff --</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Date Range</label>
                                <select id="dateRangeSelect" onchange="onDateRangeChange()">
                                    <option value="this_month">This Month</option>
                                    <option value="last_month">Last Month</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div class="filter-group" id="customDateGroup" style="display: none;">
                                <label>Custom Dates</label>
                                <div style="display:flex;gap:0.5rem;align-items:center;">
                                    <input type="date" id="startDate">
                                    <span style="color:var(--text-secondary)">to</span>
                                    <input type="date" id="endDate">
                                </div>
                            </div>
                            <button class="load-btn" onclick="loadStaffHours()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 3v18h18"></path>
                                    <path d="M18 17V9M13 17V5M8 17v-3"></path>
                                </svg>
                                Load Hours
                            </button>
                        </div>
                    </div>

                    <div id="staffStatsContainer" class="stats-grid" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-label">Total Hours</div>
                            <div id="staffTotalHours" class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Projects</div>
                            <div id="staffProjectsCount" class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Days Worked</div>
                            <div id="staffDaysWorked" class="stat-value">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Hours Overview</span>
                        </div>
                        <div id="staffChartMessage" class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <h3>Select a Staff Member</h3>
                            <p>Choose a staff member and date range, then click "Load Hours"</p>
                        </div>
                        <div id="staffInlineLoading" class="inline-loading">
                            <div class="spinner-small"></div>
                            <span>Loading time entries...</span>
                        </div>
                        <div class="chart-container" id="staffChartContainer" style="display: none;">
                            <canvas id="staffHoursChart"></canvas>
                        </div>
                    </div>

                    <div class="card" id="staffServiceCard" style="display: none;">
                        <div class="card-header">
                            <span class="card-title">Hours by Service</span>
                        </div>
                        <table class="service-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Hours</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="staffServiceTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Client Hours Tab -->
            <div id="clientsTab" class="tab-content">
                <div class="dashboard">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Filter Client Hours</span>
                        </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Client</label>
                                <select id="clientSelect">
                                    <option value="">-- Select client --</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Month</label>
                                <input type="month" id="clientMonth">
                            </div>
                            <button class="load-btn" onclick="loadClientHours()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 3v18h18"></path>
                                    <path d="M18 17V9M13 17V5M8 17v-3"></path>
                                </svg>
                                Load Hours
                            </button>
                        </div>
                    </div>

                    <div id="clientStatsContainer" class="stats-grid" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-label">Monthly Estimate</div>
                            <div id="clientEstimatedHours" class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Actual Hours</div>
                            <div id="clientActualHours" class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Remaining</div>
                            <div id="clientRemainingHours" class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Status</div>
                            <div id="clientStatus" class="stat-value">-</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Monthly Hours</span>
                        </div>
                        <div id="clientChartMessage" class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <h3>Select a Client</h3>
                            <p>Choose a client and month, then click "Load Hours"</p>
                        </div>
                        <div id="clientInlineLoading" class="inline-loading">
                            <div class="spinner-small"></div>
                            <span>Loading client hours...</span>
                        </div>
                        <div class="chart-container" id="clientChartContainer" style="display: none;">
                            <canvas id="clientHoursChart"></canvas>
                        </div>
                    </div>

                    <div class="card" id="clientProjectsCard" style="display: none;">
                        <div class="card-header">
                            <span class="card-title">Hours by Project</span>
                        </div>
                        <table class="service-table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Hours</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="clientProjectsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <footer>
                <p>FreshBooks + Google Sheets Integration • Built for Project Management</p>
            </footer>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"></path>
                </svg>
                Configuration
            </h2>
            
            <div class="form-group">
                <label>Project Hours Sheet URL</label>
                <input type="text" id="googleSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                <small>Format: Project Name, Service, Estimated Hours</small>
            </div>

            <div class="form-group">
                <label>Client Hours Sheet URL</label>
                <input type="text" id="clientSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                <small>Format: FreshBooks Client ID, Monthly Hours</small>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let auth = { accessToken: null, refreshToken: null, expiresAt: null };
        let user = null;
        let businessId = null;
        let projects = [];
        let staffMembers = [];
        let clients = [];
        let servicesMap = {};
        let estimatedHours = {};
        let clientEstimates = {};
        let chart = null;
        let staffChart = null;
        let clientChart = null;
        let staffLoaded = false;
        let clientsLoaded = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.location.hash) {
                const params = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = params.get('access_token');
                const refreshToken = params.get('refresh_token');
                const expiresIn = params.get('expires_in');

                if (accessToken) {
                    auth.accessToken = accessToken;
                    auth.refreshToken = refreshToken;
                    auth.expiresAt = Date.now() + (parseInt(expiresIn) * 1000);
                    saveAuth();
                    history.replaceState(null, '', window.location.pathname);
                }
            }

            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                showToast('error', `Login failed: ${error}`);
                history.replaceState(null, '', window.location.pathname);
            }

            loadAuth();
            loadSettings();
            setDefaultDates();

            if (auth.accessToken) {
                await initializeDashboard();
            } else {
                hideLoading();
                showLoginScreen();
            }
        });

        function setDefaultDates() {
            const now = new Date();
            const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('startDate').value = firstOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = now.toISOString().split('T')[0];
            document.getElementById('clientMonth').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function showLoginScreen() { document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('dashboard').style.display = 'none'; }
        function showDashboard() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; }

        function showToast(type, message) {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function saveAuth() { localStorage.setItem('freshbooksAuth', JSON.stringify(auth)); }
        function loadAuth() {
            const saved = localStorage.getItem('freshbooksAuth');
            if (saved) {
                auth = JSON.parse(saved);
                if (auth.expiresAt && Date.now() > auth.expiresAt) refreshAccessToken();
            }
        }

        function loadSettings() {
            const url = localStorage.getItem('googleSheetUrl');
            if (url) document.getElementById('googleSheetUrl').value = url;
            const clientUrl = localStorage.getItem('clientSheetUrl');
            if (clientUrl) document.getElementById('clientSheetUrl').value = clientUrl;
        }

        function saveSheetUrls() {
            localStorage.setItem('googleSheetUrl', document.getElementById('googleSheetUrl').value.trim());
            localStorage.setItem('clientSheetUrl', document.getElementById('clientSheetUrl').value.trim());
        }

        function loginWithFreshBooks() { window.location.href = '/api/auth'; }

        function logout() {
            auth = { accessToken: null, refreshToken: null, expiresAt: null };
            user = null; businessId = null; projects = []; staffMembers = []; clients = [];
            localStorage.removeItem('freshbooksAuth');
            showLoginScreen();
        }

        async function refreshAccessToken() {
            if (!auth.refreshToken) { logout(); return false; }
            try {
                const response = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: auth.refreshToken })
                });
                if (!response.ok) throw new Error('Refresh failed');
                const data = await response.json();
                auth.accessToken = data.access_token;
                auth.refreshToken = data.refresh_token;
                auth.expiresAt = Date.now() + (data.expires_in * 1000);
                saveAuth();
                return true;
            } catch (err) { logout(); return false; }
        }

        async function apiFetch(path) {
            if (auth.expiresAt && Date.now() > auth.expiresAt - 60000) await refreshAccessToken();
            const encodedPath = encodeURIComponent(path);
            const response = await fetch(`/api/proxy?path=${encodedPath}`, {
                headers: { 'Authorization': `Bearer ${auth.accessToken}` }
            });
            if (response.status === 401) {
                const refreshed = await refreshAccessToken();
                if (refreshed) return apiFetch(path);
                throw new Error('Unauthorized');
            }
            return response.json();
        }

        async function initializeDashboard() {
            showLoading();
            try {
                const identityData = await apiFetch('/auth/api/v1/users/me');
                user = identityData.response;
                if (user.business_memberships && user.business_memberships.length > 0) {
                    const business = user.business_memberships.find(b => b.business.name) || user.business_memberships[0];
                    businessId = business.business.id;
                }
                updateUserInfo();
                showDashboard();
                await refreshData();
            } catch (err) {
                console.error('Initialization failed:', err);
                showToast('error', 'Failed to connect to FreshBooks');
                logout();
            } finally { hideLoading(); }
        }

        function updateUserInfo() {
            if (user) {
                const name = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'User';
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                document.getElementById('userInfo').style.display = 'flex';
            }
        }

        // Tab switching
        async function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'projects') {
                document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
                document.getElementById('projectsTab').classList.add('active');
            } else if (tab === 'staff') {
                document.querySelector('.nav-tab:nth-child(2)').classList.add('active');
                document.getElementById('staffTab').classList.add('active');
                if (!staffLoaded) {
                    document.getElementById('staffChartMessage').innerHTML = `
                        <div style="width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem;"></div>
                        <h3>Loading Staff...</h3>
                        <p>Fetching team member data</p>
                    `;
                    try {
                        await fetchStaffMembers();
                        populateStaffDropdown();
                        staffLoaded = true;
                    } catch (err) { console.error('Staff load error:', err); }
                    document.getElementById('staffChartMessage').innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <h3>Select a Staff Member</h3>
                        <p>Choose a staff member and date range, then click "Load Hours"</p>
                    `;
                }
            } else if (tab === 'clients') {
                document.querySelector('.nav-tab:nth-child(3)').classList.add('active');
                document.getElementById('clientsTab').classList.add('active');
                if (!clientsLoaded) {
                    document.getElementById('clientChartMessage').innerHTML = `
                        <div style="width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem;"></div>
                        <h3>Loading Clients...</h3>
                        <p>Fetching client data</p>
                    `;
                    try {
                        await fetchClients();
                        await fetchClientEstimates();
                        populateClientDropdown();
                        clientsLoaded = true;
                    } catch (err) { console.error('Clients load error:', err); }
                    document.getElementById('clientChartMessage').innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <h3>Select a Client</h3>
                        <p>Choose a client and month, then click "Load Hours"</p>
                    `;
                }
            }
        }

        // Date range handling
        function onDateRangeChange() {
            const select = document.getElementById('dateRangeSelect');
            const customGroup = document.getElementById('customDateGroup');
            
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                const now = new Date();
                let startDate, endDate;
                if (select.value === 'this_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = now;
                } else if (select.value === 'last_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                }
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            }
        }

        async function refreshData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.classList.add('loading');
            try {
                await Promise.all([
                    fetchFreshBooksProjects(),
                    fetchServices(),
                    fetchGoogleSheetEstimates()
                ]);
                populateProjectDropdown();
                showToast('success', 'Data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('error', 'Failed to fetch data');
            } finally { refreshBtn.classList.remove('loading'); }
        }

        async function fetchFreshBooksProjects() {
            if (!businessId) return;
            try {
                const data = await apiFetch(`/projects/business/${businessId}/projects?per_page=100`);
                if (data.projects) {
                    projects = data.projects.map(p => ({ id: p.id, title: p.title, services: p.services || [] }));
                    window.projectNameMap = {};
                    projects.forEach(p => { window.projectNameMap[p.id] = p.title; });
                }
            } catch (err) { console.error('Failed to fetch projects:', err); throw err; }
        }

        async function fetchServices() {
            if (!businessId) return;
            try {
                const data = await apiFetch(`/comments/business/${businessId}/services`);
                if (data.services) {
                    servicesMap = {};
                    data.services.forEach(s => { servicesMap[s.id] = s.name; });
                }
            } catch (err) { console.error('Failed to fetch services:', err); }
        }

        async function fetchStaffMembers() {
            if (!businessId) return;
            try {
                const memberNames = {};
                const businessData = await apiFetch(`/auth/api/v1/users/business/${businessId}`);
                if (businessData.response && businessData.response.business_group && businessData.response.business_group.members) {
                    businessData.response.business_group.members.forEach(m => {
                        const name = `${m.first_name || ''} ${m.last_name || ''}`.trim();
                        if (name) memberNames[m.identity_id] = name;
                    });
                }
                const projectsToCheck = projects.slice(0, 10);
                const projectPromises = projectsToCheck.map(project => 
                    apiFetch(`/projects/business/${businessId}/project/${project.id}`).catch(() => null)
                );
                const projectResults = await Promise.all(projectPromises);
                projectResults.forEach(projectData => {
                    if (projectData && projectData.project && projectData.project.group && projectData.project.group.members) {
                        projectData.project.group.members.forEach(m => {
                            if (m.identity_id && !memberNames[m.identity_id]) {
                                const name = `${m.first_name || ''} ${m.last_name || ''}`.trim();
                                if (name) memberNames[m.identity_id] = name;
                            }
                        });
                    }
                });
                staffMembers = Object.entries(memberNames).map(([id, name]) => ({ identity_id: parseInt(id), name: name }));
                staffMembers.sort((a, b) => a.name.localeCompare(b.name));
                window.staffNameMap = memberNames;
                console.log('Staff loaded:', staffMembers.length);
            } catch (err) { console.error('Failed to fetch staff:', err); }
        }

        async function fetchClients() {
            if (!businessId) return;
            try {
                // Get account ID from user's business memberships
                const accountId = user.business_memberships.find(b => b.business.id == businessId)?.business.account_id;
                if (!accountId) {
                    console.error('No account ID found');
                    return;
                }
                console.log('Account ID:', accountId);
                
                const data = await apiFetch(`/accounting/account/${accountId}/users/clients?per_page=100`);
                if (data.response && data.response.result && data.response.result.clients) {
                    clients = data.response.result.clients.map(c => ({
                        id: c.id,
                        name: c.organization || `${c.fname || ''} ${c.lname || ''}`.trim() || `Client ${c.id}`
                    }));
                    clients.sort((a, b) => a.name.localeCompare(b.name));
                }
                console.log('Clients loaded:', clients.length);
            } catch (err) { console.error('Failed to fetch clients:', err); }
        }

        async function fetchClientEstimates() {
            const url = localStorage.getItem('clientSheetUrl');
            if (!url) return;
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) return;
            const sheetId = match[1];
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Google Sheets error');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                clientEstimates = {};
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const parts = parseCSVLine(line);
                    if (parts.length >= 2) {
                        const clientId = parts[0].trim();
                        const hours = parseFloat(parts[1].trim());
                        if (clientId && !isNaN(hours)) {
                            clientEstimates[clientId] = hours;
                        }
                    }
                }
                console.log('Client estimates loaded:', Object.keys(clientEstimates).length);
            } catch (err) { console.error('Failed to fetch client estimates:', err); }
        }

        async function fetchProjectTimeEntries(projectId) {
            if (!businessId) return [];
            try {
                let allEntries = [];
                let page = 1;
                let hasMore = true;
                while (hasMore) {
                    const path = `/timetracking/business/${businessId}/time_entries?team=1&project_id=${projectId}&per_page=100&page=${page}`;
                    const data = await apiFetch(path);
                    if (data.time_entries && data.time_entries.length > 0) {
                        allEntries = allEntries.concat(data.time_entries);
                        hasMore = data.meta && page < data.meta.pages;
                        page++;
                    } else { hasMore = false; }
                }
                return allEntries;
            } catch (err) { console.error('Failed to fetch time entries:', err); return []; }
        }

        async function fetchStaffTimeEntries(identityId, startDate, endDate) {
            if (!businessId) return [];
            try {
                const startISO = `${startDate}T00:00:00Z`;
                const endISO = `${endDate}T23:59:59Z`;
                let allEntries = [];
                let page = 1;
                let hasMore = true;
                while (hasMore) {
                    const path = `/timetracking/business/${businessId}/time_entries?team=1&identity_id=${identityId}&started_from=${startISO}&started_to=${endISO}&per_page=100&page=${page}`;
                    const data = await apiFetch(path);
                    if (data.time_entries && data.time_entries.length > 0) {
                        allEntries = allEntries.concat(data.time_entries);
                        hasMore = data.meta && page < data.meta.pages;
                        page++;
                    } else { hasMore = false; }
                }
                return allEntries;
            } catch (err) { console.error('Failed to fetch staff time entries:', err); return []; }
        }

        async function fetchClientTimeEntries(clientId, year, month) {
            if (!businessId) return [];
            try {
                const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                const endDate = new Date(year, month, 0).toISOString().split('T')[0];
                const startISO = `${startDate}T00:00:00Z`;
                const endISO = `${endDate}T23:59:59Z`;
                let allEntries = [];
                let page = 1;
                let hasMore = true;
                while (hasMore) {
                    const path = `/timetracking/business/${businessId}/time_entries?team=1&client_id=${clientId}&started_from=${startISO}&started_to=${endISO}&per_page=100&page=${page}`;
                    const data = await apiFetch(path);
                    if (data.time_entries && data.time_entries.length > 0) {
                        allEntries = allEntries.concat(data.time_entries);
                        hasMore = data.meta && page < data.meta.pages;
                        page++;
                    } else { hasMore = false; }
                }
                return allEntries;
            } catch (err) { console.error('Failed to fetch client time entries:', err); return []; }
        }

        async function fetchGoogleSheetEstimates() {
            const url = localStorage.getItem('googleSheetUrl');
            if (!url) return;
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) return;
            const sheetId = match[1];
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Google Sheets error');
                const csvText = await response.text();
                parseEstimatesCSV(csvText);
            } catch (err) { console.error('Failed to fetch estimates:', err); }
        }

        function parseEstimatesCSV(csvText) {
            const lines = csvText.split('\n');
            estimatedHours = {};
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const parts = parseCSVLine(line);
                if (parts.length >= 3) {
                    const projectName = parts[0].trim();
                    const serviceName = parts[1].trim();
                    const hours = parseFloat(parts[2].trim());
                    if (projectName && serviceName && !isNaN(hours)) {
                        if (!estimatedHours[projectName]) estimatedHours[projectName] = {};
                        estimatedHours[projectName][serviceName] = hours;
                    }
                }
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ',' && !inQuotes) { result.push(current.replace(/^"|"$/g, '')); current = ''; }
                else { current += char; }
            }
            result.push(current.replace(/^"|"$/g, ''));
            return result;
        }

        function populateProjectDropdown() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">-- Select a project --</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.title;
                select.appendChild(option);
            });
        }

        function populateStaffDropdown() {
            const select = document.getElementById('staffSelect');
            select.innerHTML = '<option value="">-- Select staff --</option>';
            staffMembers.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.identity_id;
                option.textContent = staff.name;
                select.appendChild(option);
            });
        }

        function populateClientDropdown() {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">-- Select client --</option>';
            // Only show clients that have estimates in the spreadsheet
            const estimateIds = Object.keys(clientEstimates);
            console.log('Client estimates IDs:', estimateIds);
            console.log('All clients:', clients.map(c => c.id));
            
            clients.forEach(client => {
                // Compare as strings since CSV values are strings
                if (clientEstimates[String(client.id)]) {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    select.appendChild(option);
                }
            });
        }

        // Project Hours Functions
        async function onProjectChange() {
            const select = document.getElementById('projectSelect');
            const projectId = select.value;
            if (!projectId) { hideProjectChart(); return; }
            const project = projects.find(p => p.id == projectId);
            if (project) {
                showLoading();
                try { await displayProjectData(project); }
                finally { hideLoading(); }
            }
        }

        async function displayProjectData(project) {
            const timeEntries = await fetchProjectTimeEntries(project.id);
            const hoursPerService = {};
            timeEntries.forEach(te => {
                const serviceId = te.service_id || 'unassigned';
                if (!hoursPerService[serviceId]) hoursPerService[serviceId] = 0;
                hoursPerService[serviceId] += te.duration / 3600;
            });

            const serviceData = [];
            const projectEstimates = estimatedHours[project.title] || {};
            const processedServices = new Set();
            
            for (const [serviceId, actualHours] of Object.entries(hoursPerService)) {
                let serviceName = serviceId === 'unassigned' ? 'Unassigned' : (servicesMap[serviceId] || `Service ${serviceId}`);
                let cleanName = serviceName.replace(': Non-Billable', '').replace(': Billable', '');
                let estimatedHrs = 0;
                const fullServiceName = servicesMap[serviceId] || '';
                if (projectEstimates[fullServiceName]) { estimatedHrs = projectEstimates[fullServiceName]; }
                else if (projectEstimates[cleanName]) { estimatedHrs = projectEstimates[cleanName]; }
                serviceData.push({ name: cleanName, actual: actualHours, estimated: estimatedHrs });
                processedServices.add(cleanName.toLowerCase());
            }
            
            for (const [estServiceName, estHours] of Object.entries(projectEstimates)) {
                const alreadyProcessed = Array.from(processedServices).some(name => 
                    name.includes(estServiceName.toLowerCase()) || estServiceName.toLowerCase().includes(name.split(':')[0])
                );
                if (!alreadyProcessed) {
                    serviceData.push({ name: estServiceName, actual: 0, estimated: estHours });
                }
            }

            serviceData.sort((a, b) => b.actual - a.actual);
            const filteredData = serviceData.filter(s => s.actual > 0 || s.estimated > 0);
            updateProjectChart(project.title, filteredData);
            updateProjectServiceTable(filteredData);
            const totalEstimated = filteredData.reduce((sum, s) => sum + s.estimated, 0);
            const totalActual = filteredData.reduce((sum, s) => sum + s.actual, 0);
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('estimatedHours').textContent = totalEstimated.toFixed(1) + 'h';
            document.getElementById('actualHours').textContent = totalActual.toFixed(1) + 'h';
        }

        function updateProjectChart(projectName, serviceData) {
            document.getElementById('chartMessage').style.display = 'none';
            document.querySelector('#projectsTab .chart-container').style.display = 'block';
            const ctx = document.getElementById('hoursChart').getContext('2d');
            if (chart) chart.destroy();

            const labels = serviceData.map(s => s.name);
            const estimatedData = serviceData.map(s => s.estimated);
            const actualData = serviceData.map(s => s.actual);
            const actualColors = serviceData.map(s => s.estimated === 0 ? 'rgba(88, 166, 255, 0.7)' : s.actual > s.estimated ? 'rgba(248, 81, 73, 0.7)' : 'rgba(63, 185, 80, 0.7)');
            const actualBorders = serviceData.map(s => s.estimated === 0 ? 'rgba(88, 166, 255, 1)' : s.actual > s.estimated ? 'rgba(248, 81, 73, 1)' : 'rgba(63, 185, 80, 1)');

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Estimated Hours', data: estimatedData, backgroundColor: 'rgba(88, 166, 255, 0.7)', borderColor: 'rgba(88, 166, 255, 1)', borderWidth: 2, borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.8 },
                        { label: 'Actual Hours', data: actualData, backgroundColor: actualColors, borderColor: actualBorders, borderWidth: 2, borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.8 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: {
                        legend: { position: 'top', labels: { color: '#8b949e', font: { family: "'DM Sans', sans-serif", size: 13 }, padding: 20, usePointStyle: true, pointStyle: 'rectRounded' } },
                        title: { display: true, text: projectName, color: '#e6edf3', font: { family: "'DM Sans', sans-serif", size: 18, weight: '600' }, padding: { bottom: 20 } },
                        tooltip: { backgroundColor: '#21262d', titleColor: '#e6edf3', bodyColor: '#8b949e', borderColor: '#30363d', borderWidth: 1, cornerRadius: 8, padding: 12, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw.toFixed(1)} hours`; } } }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(48, 54, 61, 0.5)', drawBorder: false }, ticks: { color: '#8b949e', font: { family: "'Space Mono', monospace" }, callback: function(value) { return value + 'h'; } } },
                        y: { grid: { display: false }, ticks: { color: '#e6edf3', font: { family: "'DM Sans', sans-serif", size: 12 } } }
                    }
                }
            });
        }

        function updateProjectServiceTable(serviceData) {
            document.getElementById('tableCard').style.display = 'block';
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = serviceData.map(service => {
                const diff = service.estimated - service.actual;
                const progress = service.estimated > 0 ? (service.actual / service.estimated) * 100 : 0;
                let statusClass = 'on-track', statusText = 'On Track';
                if (progress >= 100) { statusClass = 'over-budget'; statusText = 'Over Budget'; }
                else if (progress >= 80) { statusClass = 'warning'; statusText = 'Warning'; }
                else if (service.estimated === 0) { statusClass = ''; statusText = 'No Estimate'; }
                return `<tr>
                    <td class="service-name">${service.name}</td>
                    <td>${service.estimated.toFixed(1)}h</td>
                    <td>${service.actual.toFixed(1)}h</td>
                    <td class="${diff < 0 ? 'over-budget' : ''}">${diff.toFixed(1)}h</td>
                    <td class="${statusClass}">${statusText}</td>
                </tr>`;
            }).join('');
        }

        function hideProjectChart() {
            document.getElementById('chartMessage').style.display = 'flex';
            document.querySelector('#projectsTab .chart-container').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('tableCard').style.display = 'none';
            if (chart) { chart.destroy(); chart = null; }
        }

        // Staff Hours Functions
        async function loadStaffHours() {
            const staffId = document.getElementById('staffSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!staffId) { showToast('error', 'Please select a staff member'); return; }
            if (!startDate || !endDate) { showToast('error', 'Please select a date range'); return; }

            document.getElementById('staffChartMessage').style.display = 'none';
            document.getElementById('staffInlineLoading').classList.add('show');
            document.getElementById('staffChartContainer').style.display = 'none';
            document.getElementById('staffStatsContainer').style.display = 'none';
            document.getElementById('staffServiceCard').style.display = 'none';
            
            const loadBtn = document.querySelector('#staffTab .load-btn');
            loadBtn.classList.add('loading');

            try {
                const timeEntries = await fetchStaffTimeEntries(staffId, startDate, endDate);
                const staffName = staffMembers.find(s => s.identity_id == staffId)?.name || 'Staff';
                await displayStaffData(staffName, timeEntries, startDate, endDate);
            } catch (err) {
                console.error('Failed to load staff hours:', err);
                showToast('error', 'Failed to load staff hours');
            } finally {
                document.getElementById('staffInlineLoading').classList.remove('show');
                loadBtn.classList.remove('loading');
            }
        }

        async function displayStaffData(staffName, timeEntries, startDate, endDate) {
            if (timeEntries.length === 0) {
                document.getElementById('staffChartMessage').style.display = 'flex';
                document.getElementById('staffChartMessage').innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
                    <h3>No Hours Found</h3>
                    <p>${staffName} has no time entries for the selected date range</p>
                `;
                return;
            }

            const totalSeconds = timeEntries.reduce((sum, te) => sum + te.duration, 0);
            const totalHours = totalSeconds / 3600;
            const daysWorked = new Set(timeEntries.map(te => te.started_at.split('T')[0])).size;

            const hoursByProject = {};
            const missingProjectIds = [];
            timeEntries.forEach(te => {
                const projectId = te.project_id || 'no_project';
                if (!hoursByProject[projectId]) hoursByProject[projectId] = 0;
                hoursByProject[projectId] += te.duration / 3600;
                if (projectId !== 'no_project' && window.projectNameMap && !window.projectNameMap[projectId]) {
                    if (!missingProjectIds.includes(projectId)) missingProjectIds.push(projectId);
                }
            });

            if (missingProjectIds.length > 0) {
                const projectPromises = missingProjectIds.slice(0, 10).map(pid => 
                    apiFetch(`/projects/business/${businessId}/project/${pid}`).catch(() => null)
                );
                const projectResults = await Promise.all(projectPromises);
                projectResults.forEach(data => {
                    if (data && data.project) window.projectNameMap[data.project.id] = data.project.title;
                });
            }

            document.getElementById('staffStatsContainer').style.display = 'grid';
            document.getElementById('staffTotalHours').textContent = totalHours.toFixed(1) + 'h';
            document.getElementById('staffProjectsCount').textContent = Object.keys(hoursByProject).length;
            document.getElementById('staffDaysWorked').textContent = daysWorked;

            const chartData = Object.entries(hoursByProject)
                .map(([projectId, hours]) => {
                    const projectName = window.projectNameMap ? window.projectNameMap[projectId] : null;
                    return { projectId, name: projectName || (projectId === 'no_project' ? 'No Project' : `Project ${projectId}`), hours };
                })
                .sort((a, b) => b.hours - a.hours);

            updateStaffChart(staffName, chartData);

            const hoursByService = {};
            timeEntries.forEach(te => {
                const serviceId = te.service_id || 'unassigned';
                const serviceName = serviceId === 'unassigned' ? 'Unassigned' : (servicesMap[serviceId] || `Service ${serviceId}`);
                if (!hoursByService[serviceName]) hoursByService[serviceName] = 0;
                hoursByService[serviceName] += te.duration / 3600;
            });

            const serviceData = Object.entries(hoursByService).map(([name, hours]) => ({ name, hours })).sort((a, b) => b.hours - a.hours);
            updateStaffServiceTable(serviceData, totalHours);
        }

        function updateStaffChart(staffName, chartData) {
            document.getElementById('staffChartContainer').style.display = 'block';
            const ctx = document.getElementById('staffHoursChart').getContext('2d');
            if (staffChart) staffChart.destroy();

            staffChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets: [{ label: 'Hours', data: chartData.map(d => d.hours), backgroundColor: 'rgba(88, 166, 255, 0.7)', borderColor: 'rgba(88, 166, 255, 1)', borderWidth: 2, borderRadius: 6 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `${staffName} - Hours by Project`, color: '#e6edf3', font: { family: "'DM Sans', sans-serif", size: 18, weight: '600' }, padding: { bottom: 20 } },
                        tooltip: { backgroundColor: '#21262d', titleColor: '#e6edf3', bodyColor: '#8b949e', borderColor: '#30363d', borderWidth: 1, cornerRadius: 8, padding: 12, callbacks: { label: function(context) { return `${context.raw.toFixed(1)} hours`; } } }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(48, 54, 61, 0.5)', drawBorder: false }, ticks: { color: '#8b949e', font: { family: "'Space Mono', monospace" }, callback: function(value) { return value + 'h'; } } },
                        y: { grid: { display: false }, ticks: { color: '#e6edf3', font: { family: "'DM Sans', sans-serif", size: 11 } } }
                    }
                }
            });
        }

        function updateStaffServiceTable(serviceData, totalHours) {
            document.getElementById('staffServiceCard').style.display = 'block';
            const tbody = document.getElementById('staffServiceTableBody');
            tbody.innerHTML = serviceData.map(service => {
                const percentage = totalHours > 0 ? (service.hours / totalHours) * 100 : 0;
                return `<tr>
                    <td class="service-name">${service.name.replace(': Non-Billable', '').replace(': Billable', '')}</td>
                    <td>${service.hours.toFixed(1)}h</td>
                    <td>${percentage.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        // Client Hours Functions
        async function loadClientHours() {
            const clientId = document.getElementById('clientSelect').value;
            const monthValue = document.getElementById('clientMonth').value;
            if (!clientId) { showToast('error', 'Please select a client'); return; }
            if (!monthValue) { showToast('error', 'Please select a month'); return; }

            const [year, month] = monthValue.split('-').map(Number);

            document.getElementById('clientChartMessage').style.display = 'none';
            document.getElementById('clientInlineLoading').classList.add('show');
            document.getElementById('clientChartContainer').style.display = 'none';
            document.getElementById('clientStatsContainer').style.display = 'none';
            document.getElementById('clientProjectsCard').style.display = 'none';
            
            const loadBtn = document.querySelector('#clientsTab .load-btn');
            loadBtn.classList.add('loading');

            try {
                const timeEntries = await fetchClientTimeEntries(clientId, year, month);
                const clientName = clients.find(c => c.id == clientId)?.name || 'Client';
                const estimated = clientEstimates[String(clientId)] || 0;
                displayClientData(clientName, timeEntries, estimated, year, month);
            } catch (err) {
                console.error('Failed to load client hours:', err);
                showToast('error', 'Failed to load client hours');
            } finally {
                document.getElementById('clientInlineLoading').classList.remove('show');
                loadBtn.classList.remove('loading');
            }
        }

        function displayClientData(clientName, timeEntries, estimated, year, month) {
            const totalSeconds = timeEntries.reduce((sum, te) => sum + te.duration, 0);
            const totalHours = totalSeconds / 3600;
            const remaining = estimated - totalHours;
            
            // Determine status
            let statusText, statusClass;
            const progress = estimated > 0 ? (totalHours / estimated) * 100 : 0;
            if (progress >= 100) { statusText = 'Over'; statusClass = 'danger'; }
            else if (progress >= 80) { statusText = 'Warning'; statusClass = 'warning'; }
            else { statusText = 'On Track'; statusClass = 'success'; }

            document.getElementById('clientStatsContainer').style.display = 'grid';
            document.getElementById('clientEstimatedHours').textContent = estimated.toFixed(1) + 'h';
            document.getElementById('clientActualHours').textContent = totalHours.toFixed(1) + 'h';
            
            const remainingEl = document.getElementById('clientRemainingHours');
            remainingEl.textContent = remaining.toFixed(1) + 'h';
            remainingEl.className = 'stat-value';
            if (remaining < 0) remainingEl.classList.add('danger');
            else remainingEl.classList.add('success');

            const statusEl = document.getElementById('clientStatus');
            statusEl.textContent = statusText;
            statusEl.className = 'stat-value ' + statusClass;

            if (timeEntries.length === 0) {
                document.getElementById('clientChartMessage').style.display = 'flex';
                document.getElementById('clientChartMessage').innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
                    <h3>No Hours Found</h3>
                    <p>${clientName} has no time entries for this month</p>
                `;
                return;
            }

            // Group by project
            const hoursByProject = {};
            timeEntries.forEach(te => {
                const projectId = te.project_id || 'no_project';
                if (!hoursByProject[projectId]) hoursByProject[projectId] = 0;
                hoursByProject[projectId] += te.duration / 3600;
            });

            const chartData = Object.entries(hoursByProject)
                .map(([projectId, hours]) => {
                    const projectName = window.projectNameMap ? window.projectNameMap[projectId] : null;
                    return { projectId, name: projectName || (projectId === 'no_project' ? 'No Project' : `Project ${projectId}`), hours };
                })
                .sort((a, b) => b.hours - a.hours);

            updateClientChart(clientName, chartData, estimated, totalHours);
            updateClientProjectsTable(chartData, totalHours);
        }

        function updateClientChart(clientName, chartData, estimated, actual) {
            document.getElementById('clientChartContainer').style.display = 'block';
            const ctx = document.getElementById('clientHoursChart').getContext('2d');
            if (clientChart) clientChart.destroy();

            // Horizontal bar showing estimated vs actual
            clientChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Hours'],
                    datasets: [
                        { label: 'Estimated', data: [estimated], backgroundColor: 'rgba(88, 166, 255, 0.7)', borderColor: 'rgba(88, 166, 255, 1)', borderWidth: 2, borderRadius: 6, barPercentage: 0.6 },
                        { label: 'Actual', data: [actual], backgroundColor: actual > estimated ? 'rgba(248, 81, 73, 0.7)' : 'rgba(63, 185, 80, 0.7)', borderColor: actual > estimated ? 'rgba(248, 81, 73, 1)' : 'rgba(63, 185, 80, 1)', borderWidth: 2, borderRadius: 6, barPercentage: 0.6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: {
                        legend: { position: 'top', labels: { color: '#8b949e', font: { family: "'DM Sans', sans-serif", size: 13 }, padding: 20, usePointStyle: true, pointStyle: 'rectRounded' } },
                        title: { display: true, text: `${clientName} - Monthly Hours`, color: '#e6edf3', font: { family: "'DM Sans', sans-serif", size: 18, weight: '600' }, padding: { bottom: 20 } },
                        tooltip: { backgroundColor: '#21262d', titleColor: '#e6edf3', bodyColor: '#8b949e', borderColor: '#30363d', borderWidth: 1, cornerRadius: 8, padding: 12, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw.toFixed(1)} hours`; } } }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(48, 54, 61, 0.5)', drawBorder: false }, ticks: { color: '#8b949e', font: { family: "'Space Mono', monospace" }, callback: function(value) { return value + 'h'; } } },
                        y: { grid: { display: false }, ticks: { display: false } }
                    }
                }
            });
        }

        function updateClientProjectsTable(projectData, totalHours) {
            document.getElementById('clientProjectsCard').style.display = 'block';
            const tbody = document.getElementById('clientProjectsTableBody');
            tbody.innerHTML = projectData.map(project => {
                const percentage = totalHours > 0 ? (project.hours / totalHours) * 100 : 0;
                return `<tr>
                    <td class="service-name">${project.name}</td>
                    <td>${project.hours.toFixed(1)}h</td>
                    <td>${percentage.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        // Settings
        function openSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }

        async function saveSettings() {
            saveSheetUrls();
            closeSettings();
            await fetchGoogleSheetEstimates();
            await fetchClientEstimates();
            const select = document.getElementById('projectSelect');
            if (select.value) onProjectChange();
            showToast('success', 'Settings saved');
        }

        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeSettings();
        });
    </script>
</body>
</html>
